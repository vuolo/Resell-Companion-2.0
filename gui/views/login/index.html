<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Resell Companion â€” Login</title>

	<link rel="stylesheet" type="text/css" id="applicationStylesheet" href="./css/style.css"/>
	<link rel="stylesheet" type="text/css" id="applicationStylesheet" href="../../css/fonts-alt-path.css"/>
</head>

<body>

	<div id="Login">
		<img id="Background" src="../../images/background.png">
		<div id="Login_Button">
			<svg class="Login_Button_Rectangle">
				<rect fill="rgba(114,137,218,1)" id="Login_Button_Rectangle" rx="10" ry="10" x="0" y="0" width="265" height="50">
				</rect>
			</svg>
			<div id="Login_With_Discord_Text">
				<span>Login With Discord</span>
			</div>
			<img id="Discord_Icon" src="./images/Discord_Icon.png" srcset="./images/Discord_Icon.png 1x, ./images/Discord_Icon@2x.png 2x">
		</div>
		<div id="Title">
			<span>Welcome to</span><br><span style="font-style:normal;font-weight:bold;">Resell Companion</span>
		</div>

		<svg class="Header_Background">
			<rect fill="rgba(243,224,185,1)" id="Header_Background" rx="5" ry="5" x="0" y="0" width="717" height="35">
			</rect>
		</svg>

		<div id="Window_Buttons">
			<svg id="close-btn" class="Close_Icon" viewBox="3.375 3.375 20 20">
				<circle cx="6.5" cy="6.5" r="6.5" transform="translate(5 6)" fill="#efefef"></circle>
				<path fill="rgba(253,53,53,1)" id="Close_Icon" d="M 13.37498569488525 3.375 C 7.850955486297607 3.375 3.375 7.850955486297607 3.375 13.37498569488525 C 3.375 18.89901542663574 7.850955486297607 23.37496948242188 13.37498569488525 23.37496948242188 C 18.89901542663574 23.37496948242188 23.37496948242188 18.89901542663574 23.37496948242188 13.37498569488525 C 23.37496948242188 7.850954532623291 18.89901542663574 3.375 13.37498569488525 3.375 Z M 15.90863418579102 16.99517250061035 L 13.37498569488525 14.46152019500732 L 10.84133434295654 16.99517250061035 C 10.54325771331787 17.29324913024902 10.0528736114502 17.29324913024902 9.75479793548584 16.99517250061035 C 9.605758666992188 16.84613227844238 9.528836250305176 16.64901733398438 9.528836250305176 16.45190238952637 C 9.528836250305176 16.25478935241699 9.605758666992188 16.05767250061035 9.75479793548584 15.90863418579102 L 12.2884464263916 13.37498569488525 L 9.75479793548584 10.84133434295654 C 9.605758666992188 10.69229602813721 9.528835296630859 10.49518203735352 9.528835296630859 10.29806613922119 C 9.528835296630859 10.10095119476318 9.605758666992188 9.903835296630859 9.75479793548584 9.754798889160156 C 10.0528736114502 9.456722259521484 10.54325580596924 9.456722259521484 10.84133434295654 9.754798889160156 L 13.3749828338623 12.28844738006592 L 15.90863418579102 9.754798889160156 C 16.20671081542969 9.456722259521484 16.69709396362305 9.456722259521484 16.99517059326172 9.754798889160156 C 17.29324722290039 10.05287456512451 17.29324722290039 10.54325866699219 16.99517059326172 10.84133529663086 L 14.46152019500732 13.37498569488525 L 16.99517250061035 15.90863418579102 C 17.29324913024902 16.20671081542969 17.29324913024902 16.69709587097168 16.99517250061035 16.99517250061035 C 16.69709396362305 17.29805374145508 16.20671081542969 17.29805374145508 15.90863418579102 16.99517250061035 Z">
				</path>
			</svg>
			<svg id="min-btn" class="Minimize_Icon" viewBox="0.563 0.563 20 20">
				<circle cx="6.5" cy="6.5" r="6.5" transform="translate(5 6)" fill="#efefef"></circle>
				<path fill="rgba(255,167,78,1)" id="Minimize_Icon" d="M 10.56248474121094 0.5625000596046448 C 5.038299083709717 0.5625000596046448 0.5625000596046448 5.038299083709717 0.5625000596046448 10.56248474121094 C 0.5625000596046448 16.086669921875 5.038299083709717 20.56246757507324 10.56248474121094 20.56246757507324 C 16.086669921875 20.56246757507324 20.56246757507324 16.086669921875 20.56246757507324 10.56248474121094 C 20.56246757507324 5.038299083709717 16.086669921875 0.5625000596046448 10.56248474121094 0.5625000596046448 Z M 5.239912033081055 12.17538452148438 C 4.973783016204834 12.17538452148438 4.756041526794434 11.95764350891113 4.756041526794434 11.69151401519775 L 4.756041526794434 9.433454513549805 C 4.756041526794434 9.167325973510742 4.973783016204834 8.949583053588867 5.239912033081055 8.949583053588867 L 15.8850564956665 8.949583053588867 C 16.15118598937988 8.949583053588867 16.36892700195313 9.167325973510742 16.36892700195313 9.433454513549805 L 16.36892700195313 11.69151401519775 C 16.36892700195313 11.95764350891113 16.15118598937988 12.17538452148438 15.8850564956665 12.17538452148438 L 5.239912033081055 12.17538452148438 Z">
				</path>
			</svg>
		</div>

	</div>
	</div>

	<script>

	const electron = require('electron');

	var minimize = document.querySelector("#min-btn");
	var close = document.querySelector("#close-btn");

	minimize.addEventListener("click", function (e) {
		var window = electron.remote.BrowserWindow.getFocusedWindow();
		window.minimize();
	});

	close.addEventListener("click", function (e) {
		closeApplication();
	});

	function closeApplication(restart = false) {
	  if (restart) {
	    electron.ipcRenderer.sendSync('logoutFinished', true);
	  } else {
			var window = electron.remote.BrowserWindow.getFocusedWindow();
			window.close();
	  }
	}

	// In renderer process (web page).
	const ipcRenderer = require('electron').ipcRenderer;

	const loginButton = document.querySelector('#Login_Button');

	loginButton.addEventListener("click", function (e) {
	  launchDiscordLogin(true);
	});

	function startLogin(code) {
	  console.log(code);
	  ipcRenderer.sendSync('loginFinished', code);
	}

	function launchDiscordLogin(showFrame) {
	  const { BrowserWindow } = require('electron').remote;
	  const path = require('path');
	  const iconPath = process.platform != "darwin" ? path.resolve(__dirname, '../../../build-assets/icons/win-icon.ico') : undefined;
	  let win = new BrowserWindow({ width: 500, height: 820, frame: false, show: showFrame, icon: iconPath, autoHideMenuBar: true, webPreferences: { nodeIntegration: false, enableRemoteModule: false, sandbox: false, preload: path.join(__dirname, '../../../utils/preload.js') } });

	  win.loadURL('https://discordapp.com/api/oauth2/authorize?client_id=650143587513663490&redirect_uri=https%3A%2F%2Fresell.monster%2Fcompanion-login&response_type=code&scope=identify%20email%20guilds.join%20guilds', {userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.106 Safari/537.36'});

	  win.webContents.on('will-navigate', (event, url) => {
	    if (url.startsWith("https://resell.monster/companion-login?code=")) {
	      event.preventDefault();
	      let urlScans = url.split('?').join('___').split('&').join('___').split('___');
	      let code;
	      for (var scan of urlScans) {
	        if (scan.includes('code=')) {
	          code = scan.replace('code=', '');
	          break;
	        }
	      }
	      if (code) {
	        win.close();
	        startLogin(code);
	      }
	    } else if (url.startsWith("https://resell.monster/companion-login?error=access_denied")) {
	      win.close();
	    }
	    if (!showFrame) {
	      try {
	        win.close();
	      } catch(err) {
	        // console.log(err);
	      }
	    }
	  });

	  win.on('closed', () => {
	    win = null;
	  });
	}

	</script>

</body>
</html>
