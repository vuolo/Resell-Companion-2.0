// set variable thats accessible outside the frame
// window.pokemon = "charmander";

// to access a variable from parent
// window.parent.out_var

// variables
window.sales = [
  {
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "ebay",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    }
  },{
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "ebay",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    }
  },{
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "ebay",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    }
  },{
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "flight club",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    }
  },{
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "stadium goods",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    }
  },{
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "stockx",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        statuses: [
          "EN_ROUTE",
          "DELIVERED"
        ]
      }
    }
  },{
    name: "Adidas Yeezy Boost 700 Wave Runner",
    color: "",
    imageURL: "https://stockx-360.imgix.net/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Images/Adidas-Yeezy-Wave-Runner-700-Solid-Grey/Lv2/img02.jpg?auto=format,compress&w=559&q=90&dpr=2&updated_at=1538080256",
    size: "XXXL",
    purchase: {
      price: 220,
      estimatedResell: 380,
      store: "Adidas",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        details: {}
      }
    },
    sale: {
      price: 420,
      fees: {
        amount: 4.75,
        isPercent: true
      },
      platform: "ebayz do you understand where",
      date: "2020-07-07",
      tracking: {
        number: "9274890198179002075020",
        carrier: "usps",
        details: {}
      }
    }
  },
];

window.modals = {
  'create': {
    visible: false
  }
}

window.openModal = (modalName) => {
  window.modals[modalName].visible = true;
}

window.modalLoadedCallback = (modalName) => {
  if (modalName == 'create') {
    salesApp.createModal = window.frames['create-modal'].modalOptions;
  }
}

window.addSale = () => {
  for (var i = 0; i < salesApp.createModal.quantity; i++) {
    salesApp.createModal.id = window.parent.parent.makeid(10); // assign a new id to each node
    window.sales.push(window.parent.parent.memory.copyObj(salesApp.createModal));
    window.sales[window.sales.length-1].quantity = 1;
  }
  // TODO: reorganize sales based on table filter
};

window.editSale = (saleIndex) => {
  window.frames['create-modal'].createApp.activeSaleIndex = saleIndex;
  window.parent.parent.memory.syncObject(window.frames['create-modal'].modalOptions, window.parent.parent.memory.copyObj(window.sales[saleIndex]));
  openModal('create');
};

window.updateSale = (saleIndex) => {
  window.parent.parent.memory.syncObject(window.sales[saleIndex], window.parent.parent.memory.copyObj(window.frames['create-modal'].modalOptions));
};

const salesApp = new Vue({
  el: "#Rewrite___Sales",
  data: {
    companionSettings: window.parent.parent.companionSettings,
    sales: window.sales,
    searchTerm: "",
    displayMode: 'table', // 'grid'
    modals: window.modals,
    createModal: {},
    displayedDateSearch: 'Jun 23 â€“ Jun 27'
  },
  methods: {
    confineTextWidth: window.parent.parent.confineTextWidth,
    calculateUnderlineWidth: window.parent.parent.calculateUnderlineWidth,
    calculateUnderlineLeftOffset: window.parent.parent.calculateUnderlineLeftOffset,
    tryTranslate: window.parent.parent.tryTranslate,
    getThemeColor: window.parent.parent.getThemeColor,
    numberWithCommas: window.parent.parent.numberWithCommas,
    tryGenerateEllipses: window.parent.parent.tryGenerateEllipses,
    openModal: window.openModal,
    editSale: window.editSale,
    calculateGridPosition: function(index) {
      return { top: (Math.floor(index/5) * (218+9)) + 10 + 'px', left: ((index%5) * (227+9)) + (10 + 25) + 'px' }
    },
    shouldDisplayModals: function() {
      for (var modal in modals) if (modals[modal].visible) return true;
      return false;
    },
    getTotalSpent: function() {
      let outSpent = 0;
      for (var sale of this.sales) outSpent += (sale.purchase.price || 0);
      return window.parent.parent.roundNumber(outSpent);
    },
    getTotalRevenue: function() {
      let outRevenue = 0;
      for (var sale of this.sales) outRevenue += this.calculateProfit(sale) + (sale.purchase.price || 0);
      return window.parent.parent.roundNumber(outRevenue);
    },
    getTotalProfit: function() {
      let outProfit = 0;
      for (var sale of this.sales) outProfit += this.calculateProfit(sale);
      return window.parent.parent.roundNumber(outProfit);
    },
    getPlatformImage: function(platform) {
      let formattedPlatform = platform.replace(new RegExp(" ", 'g'), "").toLowerCase().trim();
      switch (formattedPlatform) {
        case 'stockx':
          return 'StockX';
        case 'ebay':
          return 'eBay';
        case 'flightclub':
          return 'Flight Club';
        case 'goat':
          return 'Goat';
        case 'stadiumgoods':
          return 'Stadium Goods';
      }
      return "";
    },
    getTrackingColor: function(tracking) {
      if (!tracking.details || !tracking.details.status) return "N/A";
      switch (getStatusDescription(tracking.details.status)) {
        case 'UNKNOWN':
          return 'N/A';
        case 'SHIPPING':
          return 'yellow';
        case 'EN_ROUTE':
          return 'orange';
        case 'OUT_FOR_DELIVERY':
          return 'orange';
        case 'DELIVERED':
          return 'green';
        case 'DELAYED':
          return 'N/A';
      }
      return "N/A";
    },
    getDisplayedTrackingStatus: function(tracking) {
      if (!tracking.details || !tracking.details.status) return "N/A";
      switch (getStatusDescription(tracking.details.status)) {
        case 'UNKNOWN':
          return 'Unknown';
        case 'SHIPPING':
          return 'Shipping...';
        case 'EN_ROUTE':
          return 'En Route...';
        case 'OUT_FOR_DELIVERY':
          return 'Out for Delivery';
        case 'DELIVERED':
          return 'Delivered';
        case 'DELAYED':
          return 'Delayed';
      }
      return "N/A";
    },
    getColor: function(color) {
      switch (color) {
        case 'green':
          return 'rgba(53,178,57,1)';
        case 'yellow':
          return 'rgba(253,213,53,1)';
        case 'orange':
          return 'rgba(255,167,78,1)';
        case 'red':
          return 'rgba(253,53,53,1)';
      }
      return this.getThemeColor('rgba(29,29,29,1)');
    },
    getProfitColor: function(profit) {
      if (profit > 0) return 'green'
      else if (profit < 0) return 'red';
      return 'yellow';
    },
    calculateProfit: function(sale) {
      if (sale.sale.fees.isPercent) return window.parent.parent.roundNumber((sale.sale.price || 0) * (1 - (sale.sale.fees.amount || 0) * (1/100)) - (sale.purchase.price || 0));
      return window.parent.parent.roundNumber((sale.sale.price || 0) - (sale.sale.fees.amount || 0) - (sale.purchase.price || 0));
    },
    getDisplayedFees: function(sale) {
      if (sale.sale.fees.amount == null || sale.sale.fees.amount == 0) return this.tryTranslate("N/A");
      return sale.sale.fees.isPercent ? (sale.sale.fees.amount || 0) + "%" : this.companionSettings.currencySymbol + this.numberWithCommas(window.parent.parent.roundNumber((sale.sale.fees.amount || 0)));
    }
  }
});

function getStatusDescription(statusNumber) {
  switch (statusNumber) {
    case 0:
      return "UNKNOWN";
    case 1:
      return "SHIPPING";
    case 2:
      return "EN_ROUTE";
    case 3:
      return "OUT_FOR_DELIVERY";
    case 4:
      return "DELIVERED";
    case 5:
      return "DELAYED";
  }
  return "UNKNOWN";
}

window.onload = window.parent.subpageLoadedCallback('sales');
